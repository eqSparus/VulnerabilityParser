package ru.parser.convectors;

import lombok.AccessLevel;
import lombok.experimental.FieldDefaults;
import org.jsoup.Connection;
import org.jsoup.Jsoup;
import ru.parser.models.Item;
import ru.parser.utilits.ParseInTableRow;

import java.io.IOException;

@FieldDefaults(level = AccessLevel.PRIVATE)
public class ConvectorItem implements Convector<Item> {

    static final int TIME_WAITING = 150_000;

    @Override
    public Item convert(String path) throws IOException {
        var convectorCapec = new ConvectorCapec();
        var url = String.format("https://bdu.fstec.ru/vul/%s", path);

        var pageVul = Jsoup.connect(url)
                .timeout(TIME_WAITING)
                .method(Connection.Method.GET)
                .get();

        var cveElement = pageVul.select("table > tbody > tr > td > div > ul > li > a");
        var cweElement = pageVul.select("table > tbody > tr > td > ul > li > a");

        var cveTitle = cveElement.text();
        var map = ParseInTableRow.parseCwe(cweElement);
        var capecMap = convectorCapec.convert(map.get("url"));

        return Item.builder()
                .title(path)
                .cve(ParseInTableRow.parseCve(cveTitle))
                .cwe(map.get("cwe"))
                .capecLow(ParseInTableRow.isNullDefaultSet(capecMap.get("Low")))
                .capecMedium(ParseInTableRow.isNullDefaultSet(capecMap.get("Medium")))
                .capecHigh(ParseInTableRow.isNullDefaultSet(capecMap.get("High")))
                .noChance(ParseInTableRow.isNullDefaultSet(capecMap.get("No chance")))
                .build();
    }
}
